<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Business Page - ADVOC</title>
<style>
/* (same styling you had; kept concise) */
body { background:#f0f2f5; font-family:'Segoe UI', sans-serif; margin:0; padding:0; color:#333; }
.navbar { background:#fff; display:flex; align-items:center; padding:10px 20px; border-bottom:1px solid #ddd; gap:8px; }
.navbar input { flex:1; padding:8px; margin-left:10px; border-radius:20px; border:1px solid #ccc; }
.navbar button { padding:8px 12px; border:none; border-radius:12px; cursor:pointer; background:#1877f2; color:#fff; }
.upload-section { background:#fff; border-radius:10px; padding:24px; max-width:720px; margin:28px auto; box-shadow:0px 8px 16px rgba(0,0,0,0.06); text-align:center; }
.upload-section input[type="file"], .upload-section input[type="text"] { margin-bottom:10px; padding:10px; border-radius:10px; border:1px solid #ccc; width:80%; }
.upload-section button { border:none; border-radius:25px; padding:10px 20px; background:#42b72a; color:#fff; cursor:pointer; margin-top:10px; }
.gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; padding:20px; max-width:1200px; margin:auto; }
.media-card { background:#fff; border-radius:15px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); position:relative; }
.media-card img, .media-card video { width:100%; border-radius:12px; margin-bottom:8px; cursor:pointer; }
.user-info { display:flex; align-items:center; margin-bottom:10px; cursor:pointer; gap:8px; }
.user-info img { width:35px; height:35px; border-radius:50%; object-fit:cover; }
.caption { font-weight:bold; margin-bottom:10px; }
.like-btn { position:absolute; right:15px; bottom:18px; font-size:18px; cursor:pointer; color:#fff; padding:6px 10px; border-radius:10px; background:rgba(0,0,0,0.35); }
.like-btn.liked { color:#ff2d55; transform:scale(1.05); }
.comment-panel { position:fixed; bottom:-100%; left:0; width:100%; max-height:60%; background:#fff; border-top-left-radius:15px; border-top-right-radius:15px; transition:bottom 0.3s; overflow-y:auto; padding:20px; z-index:1000; }
.comment-panel.active { bottom:0; }
.comment-form input { padding:8px; border-radius:12px; border:1px solid #ddd; margin-right:5px; width:65%; }
.comment-form button { border-radius:12px; border:none; padding:8px 12px; background:#1877f2; color:#fff; cursor:pointer; }
.dm-panel { position:fixed; right:20px; bottom:20px; width:300px; max-height:400px; background:#fff; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1); display:flex; flex-direction:column; overflow:hidden; z-index:1000; }
#fullscreenViewer { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:2000; }
#fullscreenImg { max-width:90%; max-height:90%; border-radius:10px; }
.error { color: red; text-align:center; margin-top:8px; }
</style>
</head>
<body>

<div class="navbar">
  <a href="index.html"><button>GAMES</button></a>
  <a href="business.html"><button>BUSINESS</button></a>
  <a href="login.html"><button>LOGIN</button></a>
  <a href="sign-up.html"><button>SIGN UP</button></a>
  <input id="searchBar" placeholder="Search images...">
</div>

<div class="upload-section">
  <h2>Upload an Image â€” BUSINESS</h2>
  <div id="uploadError" class="error"></div>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="media" accept="image/*,video/*" required>
    <input type="text" name="caption" placeholder="Write something...">
    <button type="submit">Upload</button>
  </form>
</div>

<h2 style="text-align:center; margin-top:6px;">Uploaded Images</h2>
<div class="gallery" id="gallery"></div>

<!-- Comments -->
<div class="comment-panel" id="commentPanel">
  <h3>Comments <span id="commentCount">0</span></h3>
  <div class="comment-list" id="commentList"></div>
  <form class="comment-form" id="commentForm">
    <input type="text" name="text" placeholder="Add a comment..." required>
    <button type="submit">Send</button>
    <button type="button" id="cancelComment">Cancel</button>
  </form>
</div>

<!-- DM panel -->
<div class="dm-panel" id="dmPanel" style="display:none;">
  <div class="dm-header" style="padding:10px; background:#1877f2; color:#fff; display:flex; justify-content:space-between;">
    <span id="dmWith">DM</span>
    <button id="closeDM">X</button>
  </div>
  <div class="dm-messages" id="dmMessages" style="padding:10px; overflow:auto; flex:1; background:#f0f2f5;"></div>
  <div class="dm-input" style="display:flex; padding:10px; border-top:1px solid #ddd;">
    <input id="dmInput" placeholder="Type a message" style="flex:1; padding:6px; border-radius:10px; border:1px solid #ccc;">
    <button id="sendDM" style="margin-left:8px; border:none; padding:6px 10px; background:#1877f2; color:#fff; border-radius:10px;">Send</button>
  </div>
</div>

<!-- Fullscreen viewer -->
<div id="fullscreenViewer"><img id="fullscreenImg"></div>

<script>
let loggedInUser = null;
let currentPostId = null;
let dmOpen = false;

// check auth (include credentials for session cookie)
fetch("/auth-check", { credentials: "include" })
.then(r => r.json())
.then(data => {
    if (data.loggedIn) loggedInUser = data.username;
    loadGallery();
}).catch(err => {
    console.error("auth-check failed", err);
    loadGallery();
});

// load gallery
function loadGallery(){
    fetch("/business/images")
    .then(r => r.json())
    .then(images => {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";
        // optional search filter
        const q = document.getElementById("searchBar").value.toLowerCase().trim();
        images.forEach(img => {
            if (q && !(img.caption||"").toLowerCase().includes(q) && !(img.user||"").toLowerCase().includes(q)) return;

            const card = document.createElement("div");
            card.className = "media-card";

            // user info
            const userDiv = document.createElement("div");
            userDiv.className = "user-info";
            const profilePic = document.createElement("img");
            if (img.userProfile && (img.userProfile.startsWith("http") || img.userProfile.startsWith("https"))) {
                profilePic.src = img.userProfile;
            } else {
                profilePic.src = "/profile_pics/default.png";
            }
            const usernameSpan = document.createElement("span");
            usernameSpan.textContent = img.user || "Unknown";
            usernameSpan.onclick = () => openProfile(img.user);
            userDiv.appendChild(profilePic);
            userDiv.appendChild(usernameSpan);
            card.appendChild(userDiv);

            // media (use Cloudinary URL saved in 'url')
            let mediaEl;
            if (img.type === "video") {
                mediaEl = document.createElement("video");
                mediaEl.controls = true;
                mediaEl.src = img.url || "";
            } else {
                mediaEl = document.createElement("img");
                mediaEl.src = img.url || "";
                mediaEl.onclick = () => openImageFullscreen(mediaEl);
            }
            card.appendChild(mediaEl);

            // caption
            if (img.caption) {
                const cap = document.createElement("p");
                cap.className = "caption";
                cap.textContent = img.caption;
                card.appendChild(cap);
            }

            // like button (use _id)
            const likeBtn = document.createElement("div");
            likeBtn.className = "like-btn";
            likeBtn.innerText = `â¤ ${img.likes || 0}`;
            likeBtn.onclick = () => {
                const id = img._id;
                fetch(`/business/like/${id}`, { method: "POST", credentials: "include" })
                .then(r=>r.json())
                .then(data => {
                    if (data.likes !== undefined) likeBtn.innerText = `â¤ ${data.likes}`;
                    likeBtn.classList.add("liked");
                    setTimeout(()=> likeBtn.classList.remove("liked"), 300);
                }).catch(err => console.error(err));
            };
            card.appendChild(likeBtn);

            // comment button
            const commentBtn = document.createElement("button");
            commentBtn.textContent = "ðŸ’¬";
            commentBtn.style.marginTop = "8px";
            commentBtn.onclick = () => openComments(img._id);
            card.appendChild(commentBtn);

            // DM button
            const dmBtn = document.createElement("button");
            dmBtn.textContent = "DM";
            dmBtn.style.marginLeft = "8px";
            dmBtn.onclick = () => openDM(img.user);
            card.appendChild(dmBtn);

            gallery.appendChild(card);
        });
    })
    .catch(err => {
        console.error("Could not load gallery", err);
    });
}

// open profile
function openProfile(user){
    if (!user) return;
    window.location.href = `/profile.html?user=${encodeURIComponent(user)}`;
}

// fullscreen
function openImageFullscreen(el){
    const viewer = document.getElementById("fullscreenViewer");
    const fullImg = document.getElementById("fullscreenImg");
    fullImg.src = el.src;
    viewer.style.display = "flex";
}
document.getElementById("fullscreenViewer").onclick = () => {
    document.getElementById("fullscreenViewer").style.display = "none";
};

// COMMENTS
function openComments(postId){
    currentPostId = postId;
    const panel = document.getElementById("commentPanel");
    const list = document.getElementById("commentList");
    document.getElementById("commentCount").innerText = "0";
    list.innerHTML = "<div>Loading...</div>";

    fetch(`/business/comments/${postId}`)
    .then(r => r.json())
    .then(comments => {
        list.innerHTML = "";
        comments.forEach(c => {
            const d = document.createElement("div");
            d.textContent = `${c.user}: ${c.text}`;
            list.appendChild(d);
        });
        document.getElementById("commentCount").innerText = comments.length;
    }).catch(err => {
        console.error(err);
        list.innerHTML = "<div>Could not load comments</div>";
    });

    panel.classList.add("active");
}

document.getElementById("commentForm").onsubmit = function(e){
    e.preventDefault();
    const text = this.text.value.trim();
    if (!text) return;
    fetch(`/business/comments/${currentPostId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ text })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const list = document.getElementById("commentList");
            list.innerHTML = "";
            data.comments.forEach(c => {
                const d = document.createElement("div");
                d.textContent = `${c.user}: ${c.text}`;
                list.appendChild(d);
            });
            document.getElementById("commentCount").innerText = data.comments.length;
            this.reset();
        } else {
            alert(data.message || "Could not add comment");
        }
    })
    .catch(err => console.error(err));
};
document.getElementById("cancelComment").onclick = ()=> {
    document.getElementById("commentPanel").classList.remove("active");
};

// DM
const dmPanel = document.getElementById("dmPanel");
const dmMessages = document.getElementById("dmMessages");
function openDM(user){
    if (!loggedInUser) { alert("Login to DM"); return; }
    dmOpen = true;
    dmPanel.style.display = "flex";
    document.getElementById("dmWith").textContent = "DM with " + user;
    loadDM(loggedInUser, user);
}
document.getElementById("closeDM").onclick = ()=> { dmOpen=false; dmPanel.style.display="none"; };
document.getElementById("sendDM").onclick = ()=> {
    const msg = document.getElementById("dmInput").value.trim();
    if (!msg) return;
    const user = document.getElementById("dmWith").textContent.replace("DM with ", "");
    fetch(`/dm/${loggedInUser}/${user}`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ message: msg })
    }).then(r=>r.json()).then(data => {
        if (data.success) { document.getElementById("dmInput").value=""; loadDM(loggedInUser, user); }
    });
};
function loadDM(u1,u2){
    if (!dmOpen) return;
    fetch(`/dm/${u1}/${u2}`, { credentials: "include" })
    .then(r=>r.json()).then(messages => {
        dmMessages.innerHTML = "";
        messages.forEach(m => {
            const d = document.createElement("div");
            d.textContent = `${m.from}: ${m.message}`;
            dmMessages.appendChild(d);
        });
        dmMessages.scrollTop = dmMessages.scrollHeight;
    });
}
setInterval(()=> {
    if (dmOpen) {
        const user = document.getElementById("dmWith").textContent.replace("DM with ", "");
        loadDM(loggedInUser, user);
    }
}, 3000);

// UPLOAD FORM
document.getElementById("uploadForm").onsubmit = function(e){
    e.preventDefault();
    const errDiv = document.getElementById("uploadError");
    errDiv.innerText = "";
    const formData = new FormData(this);

    fetch("/business/upload", {
        method: "POST",
        credentials: "include",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadGallery();
            this.reset();
        } else {
            errDiv.innerText = data.message || "Upload failed";
        }
    })
    .catch(err => {
        console.error("upload failed", err);
        errDiv.innerText = "Upload failed (server error)";
    });
};

// SEARCH
document.getElementById("searchBar").addEventListener("input", function(){
    loadGallery();
});
</script>
</body>
</html>



<!--
i have many things to ask which include    
  1 let the person sign up to have a name that willl show to upload a pic 2 
  when signing in request for name to be identified on website 3 
  i want to be able to upload multiple file at once 4 let it be like face book or whatsapp where 
  who ever create an account on my website will have a profile and name for identifying whoever
   drop the picture or video bu name and profile he or she used in signing in 5  and add that i
    will or others will be able to message eachother privately within the website using the phone
     number and name the person used while signing in like whats app or facebook  6  let it be that
      when i tap on the person name it takes me to the persons profile like facebook or whasapp and
       isee all the images or video
 the person has uploaded and i am able to message the person within the website like facebook




<script>
    let currentImage = '';

    function loadGallery() {
        imageEl.src = "/business_uploads/" + img.filename;  // instead of "/uploads/"
 
        .then(res => res.json())
        .then(images => {
            const gallery = document.getElementById("gallery");
            gallery.innerHTML = "";

            images.forEach(img => {
                const container = document.createElement("div");
                container.className = "image-container";

                const imageEl = document.createElement("img");
                imageEl.src = "/business_uploads/" + img.filename; // business uploads folder
                container.appendChild(imageEl);

                if (img.caption) {
                    const cap = document.createElement("p");
                    cap.className = "caption";
                    cap.textContent = img.caption;
                    container.appendChild(cap);
                }

                // Like button (TikTok heart)
                const likeBtn = document.createElement("div");
                likeBtn.className = "like-btn";
                likeBtn.innerHTML = `&#10084; ${img.likes}`;
                likeBtn.onclick = () => {
                    fetch(`/like/${img.filename}`, { method: "POST" })
                    .then(res => res.json())
                    .then(data => {
                        likeBtn.innerHTML = `&#10084; ${data.likes}`;
                        likeBtn.classList.add('liked');
                        setTimeout(() => likeBtn.classList.remove('liked'), 300);
                    });
                };
                container.appendChild(likeBtn);

                // Click image to open comments
                imageEl.onclick = () => openComments(img.filename);

                gallery.appendChild(container);
            });
        });
    }

    function openComments(filename) {
        currentImage = filename;
        const panel = document.getElementById('commentPanel');
        const list = document.getElementById('commentList');

        fetch(`/business/images`) // fetch business images for comments
        .then(res => res.json())
        .then(images => {
            const img = images.find(i => i.filename === filename);
            list.innerHTML = '';
            img.comments.forEach(c => {
                const div = document.createElement('div');
                div.textContent = `${c.user}: ${c.text}`;
                list.appendChild(div);
            });
        });

        panel.classList.add('active');
    }

    // Comment form submission
    document.getElementById('commentForm').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const body = { user: formData.get('user'), text: formData.get('text') };

        fetch(`/comment/${currentImage}`, { // comments shared route
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        })
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById('commentList');
            list.innerHTML = '';
            data.comments.forEach(c => {
                const div = document.createElement('div');
                div.textContent = `${c.user}: ${c.text}`;
                list.appendChild(div);
            });
            document.getElementById('commentForm').reset();
        });
    };

    // CANCEL BUTTON
    const cancelBtn = document.getElementById('cancelComment');
    cancelBtn.onclick = () => {
        const panel = document.getElementById('commentPanel');
        panel.classList.remove('active');
    };

    loadGallery();
</script>-->
