<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADVOC ‚Äî Home</title>

  <style>
    :root{--accent:#1877f2;--muted:#f0f2f5;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--muted);color:#222}

    .navbar{display:flex;gap:10px;align-items:center;padding:12px 18px;background:#fff;border-bottom:1px solid #e6e6e6}
    .nav-right{margin-left:auto;display:flex;gap:12px;align-items:center}

    .btn{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:20px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #ccc}

    main{max-width:1100px;margin:28px auto;padding:0 16px}

    .upload-panel{background:#fff;padding:18px;border-radius:10px;margin-bottom:20px}
    .upload-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .media{width:100%;border-radius:10px}

    .actions{display:flex;gap:10px;margin-top:6px}
    .like-btn{cursor:pointer;color:#1877f2}
    .comments{margin-top:6px;font-size:14px}
  </style>
</head>

<body>

<header class="navbar">
  <h2>ADVOC</h2>

  <div class="nav-right" id="navRight">
    <a href="sign-up.html"><button class="btn ghost">Sign up</button></a>
    <a href="login.html"><button class="btn">Login</button></a>
  </div>
</header>

<main>

  <!-- Upload panel -->
  <section id="uploadPanel" class="upload-panel" style="display:none">
    <form id="uploadForm" class="upload-row" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <input type="text" name="caption" placeholder="Caption (optional)">
      <button class="btn" type="submit">Upload</button>
      <span id="uploadStatus" style="font-size:13px;color:#555"></span>
    </form>
  </section>

  <h2 style="text-align:center;margin-bottom:12px">Media Gallery</h2>
  <div class="gallery" id="gallery"></div>

</main>


<script>
// RENDER BACKEND URL
const API = "https://advvoc.onrender.com";

// ==============================================
// AUTH CHECK
// ==============================================
async function authCheck(){
  const res = await fetch(`${API}/auth-check`, { credentials:"include" });
  const data = await res.json();

  if(data.loggedIn){
    uploadPanel.style.display = "block";
    navRight.innerHTML = `
      <span>Hi, ${data.username}</span>
      <button class="btn ghost" onclick="logout()">Logout</button>
    `;
  }
}

async function logout(){
  await fetch(`${API}/logout`, { method:"POST", credentials:"include" });
  location.reload();
}

// ==============================================
// LOAD POSTS
// ==============================================
let posts = [];

async function loadPosts(){
  const res = await fetch(`${API}/images`);
  posts = await res.json();
  renderGallery();
}

// ==============================================
// RENDER GALLERY
// ==============================================
function renderGallery(){
  gallery.innerHTML = "";

  posts.forEach(p => {
    const media = p.type === "video"
      ? `<video class="media" src="${p.url}" controls></video>`
      : `<img class="media" src="${p.url}">`;

    gallery.innerHTML += `
      <div class="card">
        ${media}
        ${p.caption ? `<div><b>${p.caption}</b></div>` : ""}

        <div class="actions">
          <span class="like-btn" onclick="likePost('${p._id}')">üëç ${p.likes}</span>
        </div>

        <div class="comments">
          ${(p.comments || []).map(c => `<div><b>${c.user}:</b> ${c.text}</div>`).join("")}
        </div>

        <form onsubmit="commentPost(event,'${p._id}')">
          <input name="text" placeholder="Add comment‚Ä¶" style="width:100%;padding:6px;margin-top:6px">
        </form>
      </div>
    `;
  });
}

// ==============================================
// LIKE POST
// ==============================================
async function likePost(id){
  const res = await fetch(`${API}/like/${id}`, { method:"POST" });
  const data = await res.json();
  if(data.success) loadPosts();
}

// ==============================================
// COMMENT POST
// ==============================================
async function commentPost(e, id){
  e.preventDefault();
  const text = e.target.text.value.trim();
  if(!text) return;

  await fetch(`${API}/comment/${id}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    credentials:"include",
    body: JSON.stringify({ text })
  });

  e.target.reset();
  loadPosts();
}

// ==============================================
// UPLOAD
// ==============================================
uploadForm.onsubmit = async e =>{
  e.preventDefault();
  uploadStatus.textContent = "Uploading...";

  const fd = new FormData(uploadForm);

  const res = await fetch(`${API}/upload`, {
    method:"POST",
    body: fd,
    credentials:"include"
  });

  const data = await res.json();

  if(data.success){
    uploadStatus.textContent = "Uploaded ‚úî";
    uploadForm.reset();
    loadPosts();
  } else {
    uploadStatus.textContent = "Upload failed";
  }
};

// ==============================================
(async()=>{
  await authCheck();
  await loadPosts();
})();
</script>

</body>
</html>
